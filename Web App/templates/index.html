<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Analysis Dashboard</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
      :root {
        --primary-color: #2962ff;
        --secondary-color: #0039cb;
        --background-color: #f5f7fa;
        --card-bg: #ffffff;
        --text-primary: #333333;
        --text-secondary: #666666;
        --positive-color: #00c853;
        --negative-color: #ff1744;
        --neutral-color: #757575;
        --border-color: #e0e0e0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--background-color);
        color: var(--text-primary);
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
      }

      .search-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto 30px;
      }

      .search-box {
        width: 100%;
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: 15px 20px;
        font-size: 18px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 2px 12px rgba(41, 98, 255, 0.15);
      }

      .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
      }

      .stock-info {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .stock-details {
        flex-grow: 1;
      }

      .stock-name {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stock-ticker {
        font-size: 18px;
        color: var(--text-secondary);
        margin-bottom: 10px;
      }

      .stock-price {
        font-size: 24px;
        font-weight: bold;
      }

      .stock-change {
        margin-left: 15px;
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
      }

      .positive {
        color: var(--positive-color);
      }

      .negative {
        color: var(--negative-color);
      }

      .main-chart {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .chart-title {
        font-size: 20px;
        font-weight: bold;
      }

      .time-filters {
        display: flex;
      }

      .time-filter {
        padding: 6px 12px;
        margin-left: 8px;
        background-color: transparent;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .time-filter.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .time-filter:hover:not(.active) {
        background-color: rgba(41, 98, 255, 0.1);
      }

      .analysis-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 25px;
        margin-bottom: 30px;
      }

      .analysis-card {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        position: relative;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .analysis-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-title {
        font-size: 18px;
        font-weight: bold;
      }

      .card-actions {
        display: flex;
      }

      .card-action {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: var(--text-secondary);
        margin-left: 10px;
        transition: color 0.2s;
      }

      .card-action:hover {
        color: var(--primary-color);
      }

      .card-content {
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        position: relative;
        background-color: var(--card-bg);
        margin: 5% auto;
        padding: 30px;
        width: 60%; /* Increase from 80% to 90% */
        max-width: 1200px; /* Increase from 1000px to 1200px */
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
      }

      .close-modal {
        position: absolute;
        right: 20px;
        top: 15px;
        font-size: 24px;
        font-weight: bold;
        color: var(--text-secondary);
        cursor: pointer;
      }

      .modal-chart-container {
        height: 600px; /* Increase from 500px to 600px */
        margin-top: 20px;
      }

      .portfolio-modal-layout {
        display: flex;
        width: 100%;
        height: 100%;
      }

      .pie-chart-container {
        width: 60%;
        height: 500px;
      }

      .modal-chart-container .portfolio-allocation {
        width: 40%;
        max-height: 500px;
        padding-left: 20px;
        margin-top: 50px;
        overflow-y: auto;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        height: 100%;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--primary-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .search-results {
        position: absolute;
        width: 100%;
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
      }

      .search-result-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
      }

      .search-result-item:hover {
        background-color: rgba(41, 98, 255, 0.05);
      }

      .search-result-name {
        font-weight: bold;
      }

      .search-result-ticker {
        color: var(--text-secondary);
        font-size: 14px;
        margin-left: 8px;
      }

      .portfolio-card {
        min-height: 520px;
      }

      .zoom-active {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
        margin: 5%;
        transform: none;
        max-width: 90%;
        max-height: 90%;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 1024px) {
        .analysis-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .analysis-grid {
          grid-template-columns: 1fr;
        }

        .stock-info {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      #searchResults {
        display: none;
        position: absolute;
        width: 100%;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        border-radius: 0 0 8px 8px;
      }

      .result-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .result-item:hover {
        background-color: #f5f5f5;
      }

      /* Additional styles for the portfolio allocation card */
      .portfolio-allocation {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        height: 100%;
        overflow-y: auto;
        max-height: 250px;
        margin-top: 50px; /* Add this line to move text down */
      }

      .allocation-item {
        display: flex;
        align-items: center;
        width: 48%;
        margin-bottom: 15px;
      }
 
      #modalAllocationDetails .allocation-item {
        width: 100%;
      }

      .allocation-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
        margin-right: 8px;
      }

      .allocation-ticker {
        font-weight: bold;
        margin-right: 5px;
      }

      .allocation-percentage {
        margin-left: auto;
        font-weight: bold;
      }


      .info-icon {
        color: var(--text-secondary);
        margin-left: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: color 0.2s;
      }

      .info-icon:hover {
        color: var(--primary-color);
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 250px;
        background-color: #333;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 14px;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
      
      .portfolio-metrics {
        display: flex;
        justify-content: space-around;
        margin: 15px 0 25px;
        padding: 15px;
        background-color: rgba(41, 98, 255, 0.05);
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
      }

      .metric {
        text-align: center;
      }

      .metric-label {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .metric-value {
        font-size: 20px;
        font-weight: bold;
        color: var(--text-primary);
      }

      .metric-value.positive {
        color: var(--positive-color);
      }


    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">StockInsight</div>
      </header>

      <div class="search-container">
        <div class="search-box">
          <input
            type="text"
            id="stockSearch"
            class="search-input"
            placeholder="Search for a stock..."
            autocomplete="off"
          />
          <i class="fas fa-search search-icon"></i>
          <div id="searchResults"></div>
        </div>
      </div>

      <div id="stockContent" class="hidden">
        <div class="stock-info">
          <div class="stock-details">
            <div class="stock-name" id="stockName">Loading...</div>
            <div class="stock-ticker" id="stockTicker"></div>
            <div>
              <span class="stock-price" id="stockPrice"></span>
              <span class="stock-change" id="stockChange"></span>
            </div>
          </div>
        </div>

        <div class="main-chart">
          <div class="chart-header">
            <div class="chart-title">Stock Price History</div>
            <div class="time-filters">
              <button class="time-filter" data-period="1w">1W</button>
              <button class="time-filter" data-period="1m">1M</button>
              <button class="time-filter active" data-period="3m">3M</button>
            </div>
          </div>
          <div style="height: 400px">
            <canvas id="priceChart"></canvas>
          </div>
        </div>

        <div class="analysis-grid">
          <div class="analysis-card portfolio-card">
            <div class="card-header">
              <div class="card-title">Optimal Portfolio Allocation<i class="fas fa-info-circle info-icon" data-model="portfolio"></i></div>
              <div class="card-actions">
                <button
                  class="card-action zoom-btn"
                  data-target="portfolioAllocation"
                >
                  <i class="fas fa-expand-alt"></i>
                </button>
              </div>
            </div>
            <div class="card-content" id="portfolioAllocation">
              <div class="loading" id="portfolioLoading">
                <div class="spinner"></div>
                <div>Loading portfolio allocation...</div>
              </div>
              <div
                style="width: 100%; height: 100%; display: none"
                id="portfolioChart"
              >
                <div style="height: 200px; width: 100%">
                  <canvas id="allocationChart"></canvas>
                </div>
                <div class="portfolio-allocation" id="allocationDetails">
                  <!-- Will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <div class="analysis-card">
            <div class="card-header">
              <div class="card-title">Sentiment Analysis<i class="fas fa-info-circle info-icon" data-model="sentiment"></i></div>
              <div class="card-actions">
                <button
                  class="card-action zoom-btn"
                  data-target="sentimentAnalysis"
                >
                  <i class="fas fa-expand-alt"></i>
                </button>
              </div>
            </div>
            <div class="card-content" id="sentimentAnalysis">
              <div class="loading" id="sentimentLoading">
                <div class="spinner"></div>
                <div>Loading sentiment analysis...</div>
              </div>
              <canvas id="sentimentChart" style="display: none"></canvas>
            </div>
          </div>

          <div class="analysis-card">
            <div class="card-header">
              <div class="card-title">Price Prediction<i class="fas fa-info-circle info-icon" data-model="prediction"></i></div>
              <div class="card-actions">
                <button
                  class="card-action zoom-btn"
                  data-target="pricePrediction"
                >
                  <i class="fas fa-expand-alt"></i>
                </button>
              </div>
            </div>
            <div class="card-content" id="pricePrediction">
              <div class="loading" id="predictionLoading">
                <div class="spinner"></div>
                <div>Loading price prediction...</div>
              </div>
              <canvas id="predictionChart" style="display: none"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div
        id="initialScreen"
        class="main-chart"
        style="padding: 50px; text-align: center"
      >
        <h2>Welcome to StockInsight</h2>
        <p>
          Enter a stock symbol in the search bar above to view detailed analysis
          and predictions.
        </p>
        <div style="margin: 40px 0">
          <i
            class="fas fa-chart-line"
            style="font-size: 80px; color: #2962ff; margin-bottom: 20px"
          ></i>
        </div>
        <p>Get access to:</p>
        <div
          style="
            display: flex;
            justify-content: space-around;
            max-width: 800px;
            margin: 30px auto;
          "
        >
          <div>
            <i
              class="fas fa-chart-pie"
              style="font-size: 36px; color: #2962ff; margin-bottom: 10px"
            ></i>
            <p><strong>Portfolio Optimization</strong></p>
          </div>
          <div>
            <i
              class="fas fa-newspaper"
              style="font-size: 36px; color: #2962ff; margin-bottom: 10px"
            ></i>
            <p><strong>Sentiment Analysis</strong></p>
          </div>
          <div>
            <i
              class="fas fa-chart-line"
              style="font-size: 36px; color: #2962ff; margin-bottom: 10px"
            ></i>
            <p><strong>Price Predictions</strong></p>
          </div>
        </div>
      </div>

    </div>
      
    <footer style="text-align: center; margin-top: 30px; padding: 15px; color: var(--text-secondary);">
      Made by Achyutha Munimakula and Shiva Surya
    </footer>
  </div>

  <!-- Modals for expanded views -->
    </div>

    <!-- Modals for expanded views -->
    <div id="portfolioModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Optimal Portfolio Allocation</h2>
        
        <!-- Add portfolio metrics section -->
        <div class="portfolio-metrics">
          <div class="metric">
            <div class="metric-label">Sharpe Ratio</div>
            <div class="metric-value" id="sharpeRatio">--</div>
          </div>
          <div class="metric">
            <div class="metric-label">Expected Annual Return</div>
            <div class="metric-value" id="portfolioReturn">--</div>
          </div>
          <div class="metric">
            <div class="metric-label">Annual Volatility</div>
            <div class="metric-value" id="portfolioVolatility">--</div>
          </div>
        </div>
        
        <div class="modal-chart-container">
          <div class="portfolio-modal-layout">
            <div class="pie-chart-container">
              <canvas id="modalPortfolioChart"></canvas>
            </div>
            <div class="portfolio-allocation" id="modalAllocationDetails"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="sentimentModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Stock Sentiment Analysis</h2>
        <div class="modal-chart-container">
          <canvas id="modalSentimentChart"></canvas>
        </div>
      </div>
    </div>

    <div id="predictionModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Stock Price Prediction</h2>
        <div class="modal-chart-container">
          <canvas id="modalPredictionChart"></canvas>
        </div>
      </div>
    </div>

    <script>
      // Define color scheme for charts
      const colors = {
        primary: "#2962ff",
        secondary: "#0039cb",
        positive: "#00c853",
        negative: "#ff1744",
        neutral: "#757575",
        pastData: "#2962ff",
        futureData: "#00c853",
        portfolioColors: [
          "#2962ff",
          "#00c853",
          "#ff1744",
          "#ffc107",
          "#9c27b0",
          "#00bcd4",
          "#ff9800",
          "#607d8b",
          "#e91e63",
          "#3f51b5",
        ],
      };

      const COMPANIES_DICT = {
        "AAPL": "Apple",
        "MSFT": "Microsoft",
        "GOOGL": "Alphabet",
        "AMZN": "Amazon",
        "TSLA": "Tesla",
        "NVDA": "NVIDIA",
        "META": "Meta",
        "JPM": "JPMorgan Chase",
        "WMT": "Walmart",
        "V": "Visa"
      };

      // Initialize chart instances
      let priceChart, sentimentChart, predictionChart, allocationChart;
      let modalSentimentChart, modalPredictionChart, modalPortfolioChart;

      // Global state for the current stock
      let currentStock = null;
      let stockData = null;

      // DOM elements
      const stockSearch = document.getElementById("stockSearch");
      const searchResults = document.getElementById("searchResults");
      const stockContent = document.getElementById("stockContent");
      const initialScreen = document.getElementById("initialScreen");

      // Initialize charts when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Set up search functionality
        setupSearch();

        // Set up time filters
        setupTimeFilters();

        // Set up modal/zoom functionality
        setupModals();

        // Add this line to initialize tooltips
        setupModelInfoTooltips();
      });

      function setupSearch() {
        // Event listener for search input
        stockSearch.addEventListener("input", function () {
          const query = this.value.trim();
          fetchSearchResults(query);
          
          if (query.length === 0) {
            searchResults.style.display = "block";
          }
        });

        // Add this after the existing input event listener for stockSearch
        stockSearch.addEventListener("focus", function() {
          // Show all stocks when the search field is focused
          const allStocks = [];
          for (const ticker in COMPANIES_DICT) {
            allStocks.push({
              ticker: ticker,
              name: COMPANIES_DICT[ticker]
            });
          }
          displaySearchResults(allStocks);
        });

        // Close search results when clicking outside
        document.addEventListener("click", function (e) {
          if (e.target !== stockSearch && !searchResults.contains(e.target)) {
            searchResults.style.display = "none";
          }
        });
      }

      function fetchSearchResults(query) {
        if (query.length === 0) {
          // Show all stocks when search is empty
          const allStocks = [];
          for (const ticker in COMPANIES_DICT) {
            allStocks.push({
              ticker: ticker,
              name: COMPANIES_DICT[ticker]
            });
          }
          displaySearchResults(allStocks);
          return;
        }

        fetch(`/api/search?q=${encodeURIComponent(query)}`)
          .then((response) => response.json())
          .then((data) => {
            // Display search results
            displaySearchResults(data);
          })
          .catch((error) => {
            console.error("Error fetching search results:", error);
          });
      }
      function displaySearchResults(results) {
        if (results.length === 0) {
          searchResults.style.display = "none";
          return;
        }

        searchResults.innerHTML = "";

        results.forEach((stock) => {
          const resultItem = document.createElement("div");
          resultItem.className = "result-item";
          resultItem.innerHTML = `
                    <span class="search-result-name">${stock.name}</span>
                    <span class="search-result-ticker">${stock.ticker}</span>
                `;

          resultItem.addEventListener("click", function () {
            loadStock(stock.ticker);
            searchResults.style.display = "none";
            stockSearch.value = `${stock.name} (${stock.ticker})`;
          });

          searchResults.appendChild(resultItem);
        });

        searchResults.style.display = "block";
      }

      function loadStock(ticker) {
        currentStock = ticker;

        // Show stock content and hide initial screen
        stockContent.classList.remove("hidden");
        initialScreen.classList.add("hidden");

        // Reset loading states
        document.getElementById("portfolioLoading").style.display = "flex";
        document.getElementById("portfolioChart").style.display = "none";
        document.getElementById("sentimentLoading").style.display = "flex";
        document.getElementById("sentimentChart").style.display = "none";
        document.getElementById("predictionLoading").style.display = "flex";
        document.getElementById("predictionChart").style.display = "none";

        // Fetch stock data
        Promise.all([
          fetch(`/api/stock/${ticker}`).then((res) => res.json()),
          fetch(`/api/portfolio`).then((res) => res.json()),
          fetch(`/api/sentiment/${ticker}`).then((res) => res.json()),
          fetch(`/api/prediction/${ticker}`).then((res) => res.json()),
        ])
          .then(([stockData, portfolioData, sentimentData, predictionData]) => {
            // Update main stock information
            updateStockInfo(stockData);

            // Update price chart
            updatePriceChart(stockData);

            // Update portfolio allocation chart
            updatePortfolioChart(portfolioData);

            // Update sentiment analysis chart
            updateSentimentChart(sentimentData);

            // Update prediction chart
            updatePredictionChart(predictionData, stockData);
          })
          .catch((error) => {
            console.error("Error loading stock data:", error);
          });
      }

      function updateStockInfo(stockData) {
        document.getElementById("stockName").textContent = stockData.name;
        document.getElementById("stockTicker").textContent = stockData.ticker;
        document.getElementById(
          "stockPrice"
        ).textContent = `$${stockData.current_price.toFixed(2)}`;

        const changeEl = document.getElementById("stockChange");
        const change = stockData.daily_change;
        const changePercent = stockData.daily_change_percent;

        changeEl.textContent = `${change >= 0 ? "+" : ""}${change.toFixed(
          2
        )} (${change >= 0 ? "+" : ""}${changePercent.toFixed(2)}%)`;

        if (change >= 0) {
          changeEl.className = "stock-change positive";
        } else {
          changeEl.className = "stock-change negative";
        }
      }

      function updatePriceChart(stockData) {
        const ctx = document.getElementById("priceChart").getContext("2d");

        // Destroy existing chart if it exists
        if (priceChart) {
          priceChart.destroy();
        }

        // Prepare chart data
        const labels = stockData.history.dates;
        const prices = stockData.history.prices;

        priceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Price",
                data: prices,
                borderColor: colors.primary,
                backgroundColor: "rgba(41, 98, 255, 0.1)",
                borderWidth: 2,
                pointRadius: 0,
                pointHitRadius: 10,
                tension: 0.2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "index",
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `$${context.raw.toFixed(2)}`;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: {
                  display: false,
                },
              },
              y: {
                position: "right",
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                ticks: {
                  callback: function (value) {
                    return `$${value}`;
                  },
                },
              },
            },
          },
        });
      }

      function updatePortfolioMetrics(portfolioData) {
      // Update metrics in the modal
      if (portfolioData.metrics) {
        document.getElementById('sharpeRatio').textContent = portfolioData.metrics.sharpe_ratio.toFixed(2);
        
        const returnElement = document.getElementById('portfolioReturn');
        returnElement.textContent = (portfolioData.metrics.expected_return * 100).toFixed(2) + '%';
        returnElement.classList.add('positive');

        document.getElementById('portfolioVolatility').textContent = 
          (portfolioData.metrics.volatility * 100).toFixed(2) + '%';
      }
    }

      function updatePortfolioChart(portfolioData) {
        // Hide loading and show chart
        document.getElementById("portfolioLoading").style.display = "none";
        document.getElementById("portfolioChart").style.display = "block";

        const ctx = document.getElementById("allocationChart").getContext("2d");

        // Destroy existing chart if it exists
        if (allocationChart) {
          allocationChart.destroy();
        }

        // Prepare chart data
        const labels = portfolioData.allocations.map((item) => item.ticker);
        const values = portfolioData.allocations.map((item) => item.allocation);

        allocationChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: colors.portfolioColors.slice(0, labels.length),
                borderWidth: 1,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    return `${context.label}: ${(value * 100).toFixed(1)}%`;
                  },
                },
              },
            },
          },
        });

        // Also update the allocation details
        updateAllocationDetails(portfolioData.allocations, "allocationDetails");

        // Update the modal chart if it exists
        if (modalPortfolioChart) {
          updateModalPortfolioChart(portfolioData);
          updatePortfolioMetrics(portfolioData);
        }
      }

      function updateAllocationDetails(allocations, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        allocations.forEach((item, index) => {
          const allocationItem = document.createElement("div");
          allocationItem.className = "allocation-item";

          const allocationColor = document.createElement("div");
          allocationColor.className = "allocation-color";
          allocationColor.style.backgroundColor =
            colors.portfolioColors[index % colors.portfolioColors.length];

          const allocationTicker = document.createElement("div");
          allocationTicker.className = "allocation-ticker";
          allocationTicker.textContent = item.ticker;

          const allocationPercentage = document.createElement("div");
          allocationPercentage.className = "allocation-percentage";
          allocationPercentage.textContent = `${(item.allocation * 100).toFixed(
            1
          )}%`;

          allocationItem.appendChild(allocationColor);
          allocationItem.appendChild(allocationTicker);
          allocationItem.appendChild(allocationPercentage);

          container.appendChild(allocationItem);
        });
      }

      function updateSentimentChart(sentimentData) {
        // Hide loading and show chart
        document.getElementById("sentimentLoading").style.display = "none";
        document.getElementById("sentimentChart").style.display = "block";

        const ctx = document.getElementById("sentimentChart").getContext("2d");

        // Destroy existing chart if it exists
        if (sentimentChart) {
          sentimentChart.destroy();
        }

        // Prepare chart data
        const labels = sentimentData.dates;
        const sentiments = sentimentData.sentiment_scores;

        // Create dataset with color based on sentiment value
        const backgroundColors = sentiments.map((value) => {
          if (value > 0.2) return colors.positive;
          if (value < -0.2) return colors.negative;
          return colors.neutral;
        });

        sentimentChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Sentiment Score",
                data: sentiments,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    let sentiment = "Neutral";
                    if (value > 0.2) sentiment = "Positive";
                    if (value < -0.2) sentiment = "Negative";
                    return `Sentiment: ${sentiment} (${value.toFixed(2)})`;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: {
                  display: false,
                },
              },
              y: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                min: -1,
                max: 1,
              },
            },
          },
        });

        // Update the modal chart if it exists
        if (modalSentimentChart) {
          updateModalSentimentChart(sentimentData);
        }
      }

      function updatePredictionChart(predictionData, stockData) {
        // Hide loading and show chart
        document.getElementById("predictionLoading").style.display = "none";
        document.getElementById("predictionChart").style.display = "block";

        const ctx = document.getElementById("predictionChart").getContext("2d");

        // Destroy existing chart if it exists
        if (predictionChart) {
          predictionChart.destroy();
        }

        // Combine historical and prediction data
        const historicalDates = stockData.history.dates.slice(-30); // Show last 30 days
        const historicalPrices = stockData.history.prices.slice(-30);

        const predictionDates = predictionData.dates;
        const predictionPrices = predictionData.predicted_prices;

        predictionChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [...historicalDates, ...predictionDates],
            datasets: [
              {
                label: "Historical Price",
                data: [
                  ...historicalPrices,
                  ...Array(predictionDates.length).fill(null),
                ],
                borderColor: colors.pastData,
                backgroundColor: "rgba(41, 98, 255, 0.1)",
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                tension: 0.2,
              },
              {
                label: "Predicted Price",
                data: [
                  ...Array(historicalDates.length).fill(null),
                  ...predictionPrices,
                ],
                borderColor: colors.futureData,
                backgroundColor: "rgba(0, 200, 83, 0.1)",
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: true,
                tension: 0.2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "index",
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    if (context.raw === null) return "";
                    return `${context.dataset.label}: ${context.raw.toFixed(
                      2
                    )}`;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: {
                  display: false,
                },
              },
              y: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                ticks: {
                  callback: function (value) {
                    return `${value}`;
                  },
                },
              },
            },
          },
        });

        // Update the modal chart if it exists
        if (modalPredictionChart) {
          updateModalPredictionChart(predictionData, stockData);
        }
      }

      function updateModalSentimentChart(sentimentData) {
        const ctx = document
          .getElementById("modalSentimentChart")
          .getContext("2d");

        // Destroy existing chart if it exists
        if (modalSentimentChart) {
          modalSentimentChart.destroy();
        }

        // Prepare chart data
        const labels = sentimentData.dates;
        const sentiments = sentimentData.sentiment_scores;

        // Create dataset with color based on sentiment value
        const backgroundColors = sentiments.map((value) => {
          if (value > 0.2) return colors.positive;
          if (value < -0.2) return colors.negative;
          return colors.neutral;
        });

        modalSentimentChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Sentiment Score",
                data: sentiments,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    let sentiment = "Neutral";
                    if (value > 0.2) sentiment = "Positive";
                    if (value < -0.2) sentiment = "Negative";
                    return `Sentiment: ${sentiment} (${value.toFixed(2)})`;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: {
                  display: false,
                },
              },
              y: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                min: -1,
                max: 1,
              },
            },
          },
        });
      }

      function updateModalPredictionChart(predictionData, stockData) {
        const ctx = document
          .getElementById("modalPredictionChart")
          .getContext("2d");

        // Destroy existing chart if it exists
        if (modalPredictionChart) {
          modalPredictionChart.destroy();
        }

        // Combine historical and prediction data
        const historicalDates = stockData.history.dates.slice(-60); // Show more data in modal
        const historicalPrices = stockData.history.prices.slice(-60);

        const predictionDates = predictionData.dates;
        const predictionPrices = predictionData.predicted_prices;

        modalPredictionChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [...historicalDates, ...predictionDates],
            datasets: [
              {
                label: "Historical Price",
                data: [
                  ...historicalPrices,
                  ...Array(predictionDates.length).fill(null),
                ],
                borderColor: colors.pastData,
                backgroundColor: "rgba(41, 98, 255, 0.1)",
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                tension: 0.2,
              },
              {
                label: "Predicted Price",
                data: [
                  ...Array(historicalDates.length).fill(null),
                  ...predictionPrices,
                ],
                borderColor: colors.futureData,
                backgroundColor: "rgba(0, 200, 83, 0.1)",
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: true,
                tension: 0.2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "index",
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    if (context.raw === null) return "";
                    return `${context.dataset.label}: ${context.raw.toFixed(
                      2
                    )}`;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: {
                  display: false,
                },
              },
              y: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                ticks: {
                  callback: function (value) {
                    return `${value}`;
                  },
                },
              },
            },
          },
        });
      }

      function updateModalPortfolioChart(portfolioData) {
        const ctx = document
          .getElementById("modalPortfolioChart")
          .getContext("2d");

        // Destroy existing chart if it exists
        if (modalPortfolioChart) {
          modalPortfolioChart.destroy();
        }

        // Prepare chart data
        const labels = portfolioData.allocations.map((item) => item.ticker);
        const values = portfolioData.allocations.map((item) => item.allocation);

        modalPortfolioChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: colors.portfolioColors.slice(0, labels.length),
                borderWidth: 1,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            radius: '80%',
            plugins: {
              legend: {
                display: false,  // Hide legend to save space
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    return `${context.label}: ${(value * 100).toFixed(1)}%`;
                  },
                },
              },
            },
          },
        });

        // Update the allocation details
        updateAllocationDetails(
          portfolioData.allocations,
          "modalAllocationDetails"
        );
      }

      function setupTimeFilters() {
        const timeFilters = document.querySelectorAll(".time-filter");

        timeFilters.forEach((filter) => {
          filter.addEventListener("click", function () {
            // Remove active class from all filters
            timeFilters.forEach((f) => f.classList.remove("active"));

            // Add active class to clicked filter
            this.classList.add("active");

            // Handle time period filtering
            const period = this.getAttribute("data-period");

            if (currentStock) {
              filterStockData(period);
            }
          });
        });
      }

      function filterStockData(period) {
        // Get the full stock data
        fetch(`/api/stock/${currentStock}?period=${period}`)
          .then((response) => response.json())
          .then((stockData) => {
            // Update price chart with filtered data
            updatePriceChart(stockData);
          })
          .catch((error) => {
            console.error("Error fetching filtered stock data:", error);
          });
      }

      function setupModals() {
        // Setup zoom buttons
        const zoomButtons = document.querySelectorAll(".zoom-btn");

        zoomButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const target = this.getAttribute("data-target");
            openModal(target);
          });
        });

        // Setup modal close buttons
        const closeButtons = document.querySelectorAll(".close-modal");

        closeButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const modal = this.closest(".modal");
            modal.style.display = "none";
          });
        });

        // Close modals when clicking outside
        window.addEventListener("click", function (e) {
          if (e.target.classList.contains("modal")) {
            e.target.style.display = "none";
          }
        });
      }

      function openModal(target) {
        let modalId;

        // Determine which modal to open
        switch (target) {
          case "portfolioAllocation":
            modalId = "portfolioModal";
            if (currentStock) {
              // Fetch fresh data for the modal
              fetch("/api/portfolio")
                .then((response) => response.json())
                .then((portfolioData) => {
                  updateModalPortfolioChart(portfolioData);
                  updatePortfolioMetrics(portfolioData);
                });
            }
            break;
          case "sentimentAnalysis":
            modalId = "sentimentModal";
            if (currentStock) {
              // Fetch fresh data for the modal
              fetch(`/api/sentiment/${currentStock}`)
                .then((response) => response.json())
                .then((sentimentData) => {
                  updateModalSentimentChart(sentimentData);
                });
            }
            break;
          case "pricePrediction":
            modalId = "predictionModal";
            if (currentStock) {
              // Fetch fresh data for the modal
              Promise.all([
                fetch(`/api/stock/${currentStock}`).then((res) => res.json()),
                fetch(`/api/prediction/${currentStock}`).then((res) =>
                  res.json()
                ),
              ]).then(([stockData, predictionData]) => {
                updateModalPredictionChart(predictionData, stockData);
              });
            }
            break;
        }

        if (modalId) {
          document.getElementById(modalId).style.display = "block";
        }
      }

      function setupModelInfoTooltips() {
        const modelDescriptions = {
          portfolio: "This portfolio allocation uses Modern Portfolio Theory (MPT) with risk optimization based on historical variance-covariance matrices. The model aims to maximize the Sharpe ratio by finding the optimal weight for each asset in the portfolio.",
          sentiment:  "The sentiment analysis uses natural language processing with BERT-based models trained on financial news and social media data. Scores range from -1 (very negative) to +1 (very positive) representing market sentiment.",
          prediction: "This price prediction model uses a combination of LSTM neural networks and linear regression with technical indicators. The model is trained on 5 years of historical data and incorporates sentiment analysis results."
        };

        document.querySelectorAll('.info-icon').forEach(icon => {
          const modelType = icon.getAttribute('data-model');
          const text = modelDescriptions[modelType] || "No info available";

          // Create the tooltip text node
          const tt = document.createElement('span');
          tt.className = 'tooltiptext';
          tt.textContent = text;

          // Wrap the <i> in a <span class="tooltip">
          const wrapper = document.createElement('span');
          wrapper.className = 'tooltip';

          // Move the icon into the wrapper, then add the tooltip
          icon.replaceWith(wrapper);
          wrapper.appendChild(icon);
          wrapper.appendChild(tt);
        });
      }



    </script>
  </body>
</html>
